<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WordPressè¨˜äº‹ç§»ç®¡ãƒ„ãƒ¼ãƒ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            height: 100vh;
            display: grid;
            grid-template-rows: 25% 75%;
            grid-template-columns: 50% 50%;
            background: #f5f5f5;
            gap: 0;
            overflow: hidden;
        }

        .top-left-panel {
            grid-row: 1;
            grid-column: 1;
            display: flex;
            flex-direction: column;
            background: white;
            border-right: 1px solid #e0e0e0;
            border-bottom: 1px solid #e0e0e0;
            overflow: hidden;
        }

        .top-right-panel {
            grid-row: 1;
            grid-column: 2;
            display: flex;
            flex-direction: column;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            overflow: hidden;
        }

        .bottom-left-panel {
            grid-row: 2;
            grid-column: 1;
            display: flex;
            flex-direction: column;
            background: white;
            border-right: 1px solid #e0e0e0;
            overflow: hidden;
        }

        .bottom-right-panel {
            grid-row: 2;
            grid-column: 2;
            display: flex;
            flex-direction: column;
            background: white;
            overflow: hidden;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 12px 16px;
            min-height: 48px;
            box-sizing: border-box;
            display: flex;
            align-items: center;
        }

        .header h1 {
            font-size: 16px;
            margin: 0;
        }

        .paste-area {
            background: #34495e;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .paste-area label {
            display: block;
            font-size: 14px;
            margin-bottom: 8px;
            font-weight: bold;
            color: #ecf0f1;
        }

        .paste-area textarea {
            width: 100%;
            height: 120px;
            padding: 12px;
            font-size: 13px;
            border: 2px solid #7f8c8d;
            border-radius: 6px;
            background: #2c3e50;
            color: #ecf0f1;
            font-family: 'Consolas', 'Monaco', monospace;
            resize: vertical;
        }

        .paste-area textarea:focus {
            outline: none;
            border-color: #3498db;
            background: #34495e;
        }

        .paste-area textarea::placeholder {
            color: #95a5a6;
        }

        .url-input-area {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .url-input-area input {
            flex: 1;
            padding: 12px 16px;
            font-size: 14px;
            border: 2px solid #34495e;
            border-radius: 6px;
            background: white;
        }

        .url-input-area input:focus {
            outline: none;
            border-color: #3498db;
        }

        .url-input-area button {
            padding: 12px 24px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background 0.2s;
            white-space: nowrap;
        }

        .url-input-area button:hover {
            background: #2980b9;
        }

        .url-input-area button.success {
            background: #27ae60;
        }

        .url-input-area button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        .instructions {
            font-size: 13px;
            color: #bdc3c7;
            margin-top: 8px;
            line-height: 1.6;
        }

        .instructions strong {
            color: #3498db;
        }

        .loading {
            display: none;
            color: #3498db;
            font-size: 14px;
            margin-top: 8px;
        }

        .loading.active {
            display: block;
        }

        .panel-header {
            padding: 12px 16px;
            background: #ecf0f1;
            border-bottom: 1px solid #bdc3c7;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 48px;
            box-sizing: border-box;
        }

        .panel-header h2 {
            font-size: 16px;
            color: #2c3e50;
            margin: 0;
        }

        .panel-header button {
            padding: 8px 16px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            transition: background 0.2s;
        }

        .panel-header button:hover {
            background: #229954;
        }

        .panel-header button.copied {
            background: #3498db;
        }

        .title-area {
            padding: 16px;
            background: #fff9e6;
            border-bottom: 1px solid #e0e0e0;
        }

        .title-area label {
            font-size: 12px;
            color: #666;
            font-weight: bold;
            display: block;
            margin-bottom: 8px;
        }

        #titleDisplay {
            width: 100%;
            padding: 12px;
            font-size: 18px;
            font-weight: bold;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            background: white;
            resize: none;
            font-family: 'Segoe UI', sans-serif;
            min-height: 60px;
        }

        .html-output {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            line-height: 1.6;
            white-space: pre-wrap;
            background: #fafafa;
        }

        .markdown-editor {
            flex: 1;
            width: 100%;
            padding: 16px;
            font-size: 14px;
            line-height: 1.6;
            border: none;
            resize: none;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        .markdown-editor:focus {
            outline: none;
        }

        .images-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 16px;
            overflow-y: auto;
            flex: 1;
        }

        .image-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            transition: all 0.2s;
        }

        .image-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-color: #3498db;
        }

        .image-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 4px;
            cursor: grab;
            border: 1px solid #eee;
        }

        .image-item img:active {
            cursor: grabbing;
        }

        .image-item .image-info {
            font-size: 11px;
            color: #999;
            text-align: center;
            padding: 4px;
        }

        .image-item button {
            padding: 6px 10px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }

        .image-item button:hover {
            background: #2980b9;
        }

        .image-item button.copied {
            background: #27ae60;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 14px;
        }

        .toolbar {
            display: flex;
            gap: 4px;
            padding: 12px;
            background: #fafafa;
            border-bottom: 1px solid #e0e0e0;
            flex-wrap: wrap;
        }

        .toolbar button {
            padding: 6px 12px;
            border: 1px solid #d0d0d0;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .toolbar button:hover {
            background: #f0f0f0;
            border-color: #999;
        }
    </style>
</head>
<body>
    <!-- å·¦ä¸Šï¼šç”»åƒä¸€è¦§ (25%) -->
    <div class="top-left-panel">
        <div class="panel-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h2>ğŸ“· ç”»åƒä¸€è¦§</h2>
            <div style="display: flex; gap: 8px;">
                <button onclick="openAllImages()" style="padding: 6px 12px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px;">ã™ã¹ã¦ã®ç”»åƒã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã</button>
            </div>
        </div>
        <div class="images-grid" id="imagesGrid" style="padding: 12px; overflow-y: auto; flex: 1;">
            <div class="empty-state">ç”»åƒã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>
        </div>
    </div>

    <!-- å³ä¸Šï¼šHTMLã‚½ãƒ¼ã‚¹è²¼ã‚Šä»˜ã‘ (25%) -->
    <div class="top-right-panel">
        <div class="header">
            <h1>ğŸ“‹ HTMLã‚½ãƒ¼ã‚¹è²¼ã‚Šä»˜ã‘</h1>
        </div>
        <div class="paste-area" style="flex: 1; display: flex; flex-direction: column; padding: 12px;">
            <textarea id="htmlSource" placeholder="HTMLã‚½ãƒ¼ã‚¹ã‚’è²¼ã‚Šä»˜ã‘" style="flex: 1; font-size: 12px; margin-bottom: 8px;"></textarea>
            <div style="display: flex; gap: 8px;">
                <input type="text" id="urlInput" placeholder="è¨˜äº‹URL" style="flex: 1; font-size: 12px; padding: 6px 10px;">
                <button onclick="loadFromPaste()" id="loadButton" style="font-size: 12px; padding: 6px 16px; white-space: nowrap; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">èª­ã¿è¾¼ã‚€</button>
            </div>
            <div class="loading" id="loading" style="font-size: 12px; margin-top: 4px;">å‡¦ç†ä¸­...</div>
        </div>
    </div>

    <!-- å·¦ä¸‹ï¼šHTMLå‡ºåŠ› (75%) -->
    <div class="bottom-left-panel">
        <div class="panel-header">
            <h2>ğŸ“‹ HTMLå‡ºåŠ›</h2>
        </div>
        <div class="title-area" style="padding: 8px 16px;">
            <label style="font-size: 12px; margin-bottom: 4px; display: block;">ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆH1ï¼‰</label>
            <div style="display: flex; gap: 8px; align-items: stretch;">
                <textarea id="titleDisplay" readonly placeholder="H1ã‚¿ã‚¤ãƒˆãƒ«..." style="flex: 1; height: 40px; font-size: 13px;"></textarea>
                <button onclick="copyTitle()" style="padding: 6px 12px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; white-space: nowrap; font-size: 12px;">ã‚³ãƒ”ãƒ¼</button>
            </div>
        </div>
        <div class="client-area" style="padding: 8px 16px;">
            <label style="font-size: 12px; margin-bottom: 4px; display: block;">ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå</label>
            <div style="display: flex; gap: 8px; align-items: stretch;">
                <input type="text" id="clientDisplay" readonly placeholder="ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå..." style="flex: 1; height: 32px; font-size: 13px; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px;">
                <button onclick="copyClient()" style="padding: 6px 12px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; white-space: nowrap; font-size: 12px;">ã‚³ãƒ”ãƒ¼</button>
            </div>
        </div>
        <div class="slug-area" style="padding: 8px 16px;">
            <label style="font-size: 12px; margin-bottom: 4px; display: block;">ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå</label>
            <div style="display: flex; gap: 8px; align-items: stretch;">
                <input type="text" id="slugDisplay" readonly placeholder="ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå..." style="flex: 1; height: 32px; font-size: 13px; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px;">
                <button onclick="copySlug()" style="padding: 6px 12px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; white-space: nowrap; font-size: 12px;">ã‚³ãƒ”ãƒ¼</button>
            </div>
        </div>
        <div style="padding: 8px 16px; display: flex; justify-content: flex-end;">
            <button onclick="copyHTML()" id="copyHTMLBtn" style="padding: 6px 12px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; white-space: nowrap; font-size: 12px;">HTMLã‚’ã‚³ãƒ”ãƒ¼</button>
        </div>
        <div class="html-output" id="htmlOutput" style="flex: 1;">
            <div class="empty-state">URLã‚’å…¥åŠ›ã—ã¦ã€Œè¨˜äº‹ã‚’èª­ã¿è¾¼ã‚€ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</div>
        </div>
    </div>

    <!-- å³ä¸‹ï¼šãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ç·¨é›† (87.5%) -->
    <div class="bottom-right-panel">
        <div class="panel-header">
            <h2>âœï¸ ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ç·¨é›†</h2>
        </div>
        <div class="toolbar">
            <button onclick="applyFormat('h1')" title="è¦‹å‡ºã—1">H1</button>
            <button onclick="applyFormat('h2')" title="è¦‹å‡ºã—2">H2</button>
            <button onclick="applyFormat('h3')" title="è¦‹å‡ºã—3">H3</button>
            <button onclick="applyFormat('h4')" title="è¦‹å‡ºã—4">H4</button>
            <button onclick="applyFormat('h5')" title="è¦‹å‡ºã—5">H5</button>
            <button onclick="applyFormat('h6')" title="è¦‹å‡ºã—6">H6</button>
            <button onclick="applyFormat('bold')" title="å¤ªå­—"><strong>B</strong></button>
            <button onclick="clearFormat()" title="æ›¸å¼è§£é™¤">è§£é™¤</button>
            <button onclick="applyFormat('ul')" title="ç®‡æ¡æ›¸ã">â€¢</button>
            <button onclick="applyFormat('ol')" title="ç•ªå·ä»˜ããƒªã‚¹ãƒˆ">1.</button>
            <button onclick="applyFormat('caption')" title="ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³">ï¼ˆC</button>
            <button onclick="applyFormat('alt')" title="ALT">ï¼ˆALT</button>
            <button onclick="applyFormat('image')" title="ç”»åƒ">ç”»åƒ</button>
            <button onclick="applyFormat('paragraph')" title="æ®µè½">P</button>
            <button onclick="applyAlign('center')" title="ä¸­å¤®æƒãˆ">ä¸­å¤®</button>
            <button onclick="applyAlign('right')" title="å³æƒãˆ">å³</button>
            <button onclick="applyAlign('left')" title="å·¦æƒãˆ">å·¦</button>
            <button onclick="insertHR()" title="æ°´å¹³ç·š">---</button>
            <button onclick="deleteLine()" title="å‰Šé™¤" style="color: #d32f2f;">å‰Šé™¤</button>
            <button onclick="insertLineBreak()" title="æ”¹è¡Œ">æ”¹è¡Œ</button>
            <button onclick="resetAll()" title="ãƒªã‚»ãƒƒãƒˆ">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        <textarea class="markdown-editor" id="markdownEditor" placeholder="ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ç·¨é›†å†…å®¹ã¯è‡ªå‹•ã§åæ˜ ã•ã‚Œã¾ã™ã€‚"></textarea>
    </div>

    <script>
        const urlInput = document.getElementById('urlInput');
        const htmlSource = document.getElementById('htmlSource');
        const loading = document.getElementById('loading');
        const htmlOutput = document.getElementById('htmlOutput');
        const titleDisplay = document.getElementById('titleDisplay');
        const clientDisplay = document.getElementById('clientDisplay');
        const slugDisplay = document.getElementById('slugDisplay');
        const markdownEditor = document.getElementById('markdownEditor');
        const imagesGrid = document.getElementById('imagesGrid');
        
        // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³è‡ªå‹•æ›´æ–°
        markdownEditor.addEventListener('input', function() {
            updateHTML();
        });
        const loadButton = document.getElementById('loadButton');

        let articleImages = [];

        function loadFromPaste() {
            const html = htmlSource.value.trim();
            if (!html) {
                alert('âŒ HTMLã‚½ãƒ¼ã‚¹ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“\n\nè¨˜äº‹ãƒšãƒ¼ã‚¸ã®ã‚½ãƒ¼ã‚¹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚');
                return;
            }

            const url = urlInput.value.trim() || 'https://example.com/article/';
            
            loading.classList.add('active');
            loadButton.disabled = true;
            
            setTimeout(() => {
                try {
                    parseArticle(html, url);
                    loadButton.textContent = 'âœ… èª­ã¿è¾¼ã¿å®Œäº†ï¼';
                    loadButton.classList.add('success');
                    setTimeout(() => {
                        loadButton.textContent = 'è¨˜äº‹ã‚’èª­ã¿è¾¼ã‚€';
                        loadButton.classList.remove('success');
                    }, 3000);
                } catch (error) {
                    console.error('Error:', error);
                    alert('âŒ è¨˜äº‹ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ\n\nã‚¨ãƒ©ãƒ¼: ' + error.message);
                } finally {
                    loading.classList.remove('active');
                    loadButton.disabled = false;
                }
            }, 100);
        }

        function parseArticle(html, baseUrl) {
            console.log('parseArticle é–‹å§‹');
            console.log('HTML length:', html.length);
            console.log('HTML preview (first 500 chars):', html.substring(0, 500));
            
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            console.log('DOMParser å®Œäº†');
            
            // è¨˜äº‹æœ¬æ–‡ã‚’æŠ½å‡ºï¼ˆè¤‡æ•°ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¯¾å¿œï¼‰
            let articleContent = doc.querySelector('.post_content') ||
                                doc.querySelector('.entry-content') ||
                                doc.querySelector('article .entry-content') ||
                                doc.querySelector('.post-content') ||
                                doc.querySelector('article:not(.item)') ||
                                doc.querySelector('main article') ||
                                doc.querySelector('main');
            
            console.log('articleContent:', articleContent);
            console.log('articleContent tagName:', articleContent.tagName);
            console.log('articleContent className:', articleContent.className);
            console.log('articleContent children count:', articleContent.children.length);
            console.log('articleContent innerHTML preview:', articleContent.innerHTML.substring(0, 500));
            
            if (!articleContent) {
                alert('âŒ è¨˜äº‹æœ¬æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ\n\nåˆ¥ã®ãƒšãƒ¼ã‚¸ã‚’è©¦ã™ã‹ã€æ‰‹å‹•ã§ç·¨é›†ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            let markdown = '';
            let title = '';
            articleImages = [];

            // URLã‹ã‚‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåï¼ˆã‚¹ãƒ©ãƒƒã‚°ï¼‰ã‚’æŠ½å‡º
            try {
                const url = new URL(baseUrl);
                const pathname = url.pathname;
                // æœ«å°¾ã®ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤ã—ã¦ã€æœ€å¾Œã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåã‚’å–å¾—
                const parts = pathname.replace(/\/$/, '').split('/');
                const slug = parts[parts.length - 1];
                if (slug) {
                    slugDisplay.value = slug;
                    console.log('Extracted slug:', slug);
                }
            } catch (e) {
                console.warn('Failed to extract slug from URL:', e);
            }

            // H1ã‚¿ã‚¤ãƒˆãƒ«ã‚’æŠ½å‡º
            const h1 = doc.querySelector('h1') || articleContent.querySelector('h1');
            if (h1) {
                // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåã‚’å…ˆã«æŠ½å‡ºï¼ˆfont size='2' or size="2"ï¼‰
                const fontTag = h1.querySelector('font[size="2"], font[size=\'2\']');
                let clientName = '';
                if (fontTag) {
                    clientName = fontTag.textContent.trim();
                    clientDisplay.value = clientName;
                }
                
                // ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåã‚’é™¤å¤–
                let fullText = h1.textContent.trim();
                if (clientName) {
                    // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåã‚’ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰å‰Šé™¤
                    title = fullText.replace(clientName, '').trim();
                    // ä½™åˆ†ãªæ”¹è¡Œã‚„ç©ºç™½ã‚’å‰Šé™¤
                    title = title.replace(/\s+/g, ' ').trim();
                } else {
                    title = fullText;
                }
                titleDisplay.value = title;
            }

            // ãƒ¡ã‚¤ãƒ³ç”»åƒï¼ˆã‚¢ã‚¤ã‚­ãƒ£ãƒƒãƒï¼‰ã‚’æŠ½å‡º - docå…¨ä½“ã‹ã‚‰æ¢ã™
            const mainImageSelectors = ['#post_image', '#post_image_wrap > div', '.post_image', '[id*="post_image"]'];
            let mainImageFound = false;
            
            for (const selector of mainImageSelectors) {
                const mainImageDiv = doc.querySelector(selector);
                if (mainImageDiv && !mainImageFound) {
                    const style = mainImageDiv.getAttribute('style');
                    console.log('Checking element:', selector, 'style:', style);
                    if (style) {
                        const urlMatch = style.match(/url\(['"]?(https?:\/\/[^'")\s]+)['"]?\)/);
                        if (urlMatch) {
                            articleImages.push({
                                src: urlMatch[1],
                                alt: 'ã‚¢ã‚¤ã‚­ãƒ£ãƒƒãƒç”»åƒ'
                            });
                            mainImageFound = true;
                            console.log('Main image extracted:', urlMatch[1]);
                            break;
                        }
                    }
                }
            }

            // HTMLã‚½ãƒ¼ã‚¹ã‹ã‚‰ <div class="image_wrap"><div class="image" style="background:url(...)"> ã®æ§‹æˆã‚’æŠ½å‡º
            // article#article è¦ç´ å†…ã®ã¿ã‚’å¯¾è±¡ã«ã™ã‚‹
            const articleElement = doc.querySelector('article#article') || doc.querySelector('article');
            
            if (articleElement) {
                // SNSã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³ï¼ˆsingle_share_bottomï¼‰ã‚’é™¤å¤–
                const shareBottom = articleElement.querySelector('#single_share_bottom');
                if (shareBottom) {
                    shareBottom.remove();
                    console.log('Removed #single_share_bottom');
                }
                
                // å‰å¾Œè¨˜äº‹ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆnext_prev_postï¼‰ã‚’é™¤å¤–
                const nextPrevPost = articleElement.querySelector('#next_prev_post');
                if (nextPrevPost) {
                    nextPrevPost.remove();
                    console.log('Removed #next_prev_post navigation');
                }
                
                console.log('Searching for image_wrap in article#article');
                const articleHTML = articleElement.innerHTML;
                
                const imageWrapRegex = /<div\s+class=["']image_wrap["'][^>]*>[\s\S]*?<div\s+class=["']image["'][^>]*style=["']([^"']*)["'][^>]*>/i;
                const wrapMatch = articleHTML.match(imageWrapRegex);
                
                if (wrapMatch) {
                    const styleAttr = wrapMatch[1];
                    console.log('Found image_wrap div in article, style:', styleAttr);
                    const urlMatch = styleAttr.match(/background\s*:\s*url\s*\(\s*([^)]+)\s*\)/i);
                    if (urlMatch) {
                        const bgUrl = urlMatch[1].replace(/['"]/g, '').split(/\s+/)[0]; // å¼•ç”¨ç¬¦ã¨ã‚¹ãƒšãƒ¼ã‚¹ä»¥é™ã‚’é™¤å»
                        console.log('Found image_wrap background URL:', bgUrl);
                        
                        // contactç³»ã®ç”»åƒã§ãªã‘ã‚Œã°è¿½åŠ 
                        if (bgUrl.startsWith('http') && !bgUrl.includes('contact-mail') && !bgUrl.includes('contact-call')) {
                            articleImages.push({
                                src: bgUrl,
                                alt: ''
                            });
                            console.log('Added article main image:', bgUrl);
                        }
                    }
                } else {
                    console.log('No image_wrap found in article#article');
                }
            } else {
                console.log('article#article element not found');
            }

            // è¨˜äº‹å†…ã®å„è¦ç´ ã‚’é †ç•ªã«å‡¦ç†
            let stopProcessing = false; // contactç”»åƒä»¥é™ã®å‡¦ç†ã‚’ã‚¹ãƒˆãƒƒãƒ—ã™ã‚‹ãƒ•ãƒ©ã‚°
            
            function processNode(node) {
                if (stopProcessing) return; // æ—¢ã«contactç”»åƒãŒè¦‹ã¤ã‹ã£ã¦ã„ãŸã‚‰å‡¦ç†åœæ­¢
                
                const children = Array.from(node.children);
                console.log('processNode called, children count:', children.length);
                
                children.forEach((el, index) => {
                    const tagName = el.tagName;
                    console.log(`Child ${index}: ${tagName}, className: ${el.className}`);
                    
                    // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚„ã‚µã‚¤ãƒ‰ãƒãƒ¼ãªã©ã‚’ã‚¹ã‚­ãƒƒãƒ—
                    if (el.classList.contains('nav') || 
                        el.classList.contains('sidebar') ||
                        el.classList.contains('menu') ||
                        el.classList.contains('footer') ||
                        el.id === 'sidebar') {
                        console.log('  -> ã‚¹ã‚­ãƒƒãƒ—');
                        return;
                    }
                    
                    if (tagName === 'H1') {
                        // H1ã¯ã‚¿ã‚¤ãƒˆãƒ«ã¨ã—ã¦æ—¢ã«å‡¦ç†æ¸ˆã¿ãªã®ã§ã‚¹ã‚­ãƒƒãƒ—
                        return;
                    } else if (tagName === 'H2') {
                        markdown += '## ' + el.textContent.trim() + '\n';
                    } else if (tagName === 'H3') {
                        markdown += '### ' + el.textContent.trim() + '\n';
                    } else if (tagName === 'H4') {
                        markdown += '### ' + el.textContent.trim() + '\n';
                    } else if (tagName === 'H5' || tagName === 'H6') {
                        markdown += '### ' + el.textContent.trim() + '\n';
                    } else if (tagName === 'P') {
                        const text = el.textContent.trim();
                        if (text) {
                            // ç”»åƒã®ã¿ã‚’å«ã‚€pè¦ç´ ã‹ãƒã‚§ãƒƒã‚¯
                            const imgOnly = el.querySelector('img') && !text.replace(/\s/g, '');
                            if (!imgOnly) {
                                markdown += text + '\n';
                            }
                        }
                        
                        // pè¦ç´ å†…ã®iframeï¼ˆYouTubeï¼‰ã‚’ãƒã‚§ãƒƒã‚¯
                        const iframe = el.querySelector('iframe[src*="youtube.com"], iframe[src*="youtu.be"]');
                        if (iframe) {
                            markdown += iframe.outerHTML + '\n';
                        }
                        
                        // pè¦ç´ å†…ã®ç”»åƒã‚‚å‡¦ç†
                        const imgs = el.querySelectorAll('img');
                        imgs.forEach(img => {
                            processImage(img);
                        });
                    } else if (tagName === 'UL') {
                        const items = el.querySelectorAll('li');
                        items.forEach(li => {
                            markdown += '- ' + li.textContent.trim() + '\n';
                        });
                        markdown += '\n';
                    } else if (tagName === 'OL') {
                        const items = el.querySelectorAll('li');
                        items.forEach((li, i) => {
                            markdown += `${i + 1}. ${li.textContent.trim()}\n`;
                        });
                        markdown += '\n';
                    } else if (tagName === 'IMG') {
                        processImage(el);
                    } else if (tagName === 'FIGURE') {
                        // iframeï¼ˆYouTubeå‹•ç”»ãªã©ï¼‰ã‚’ãƒã‚§ãƒƒã‚¯
                        const iframe = el.querySelector('iframe');
                        if (iframe) {
                            markdown += iframe.outerHTML + '\n';
                        }
                        
                        // ç”»åƒã‚’ãƒã‚§ãƒƒã‚¯
                        const img = el.querySelector('img');
                        if (img) {
                            processImage(img);
                        }
                        
                        // ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
                        const caption = el.querySelector('figcaption');
                        if (caption) {
                            markdown += caption.textContent.trim() + 'ï¼ˆC\n';
                        }
                    } else if (tagName === 'HR') {
                        markdown += '---\n';
                    } else if (tagName === 'BLOCKQUOTE') {
                        const text = el.textContent.trim();
                        if (text) {
                            markdown += text + '\n';
                        }
                    } else if (tagName === 'IFRAME') {
                        // iframeã‚¿ã‚°ã‚’ãã®ã¾ã¾æŠ½å‡ºã—ã¦ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã«è¿½åŠ 
                        markdown += el.outerHTML + '\n';
                    } else if (tagName === 'DIV' || tagName === 'SECTION' || tagName === 'ARTICLE') {
                        // DIVå†…ã®iframeã‚‚ãƒã‚§ãƒƒã‚¯
                        const iframe = el.querySelector('iframe');
                        if (iframe) {
                            markdown += iframe.outerHTML + '\n';
                            return; // iframeè¦‹ã¤ã‹ã£ãŸã‚‰å†å¸°å‡¦ç†ã¯ã‚¹ã‚­ãƒƒãƒ—
                        }
                        
                        // div.imageã®background:url()ã‚’ãƒã‚§ãƒƒã‚¯
                        console.log('Checking DIV:', el.className, 'has image class:', el.classList.contains('image'), 'has image_wrap class:', el.classList.contains('image_wrap'));
                        
                        if (el.classList.contains('image') || el.classList.contains('image_wrap')) {
                            console.log('Found image or image_wrap div!');
                            const imageDiv = el.classList.contains('image') ? el : el.querySelector('.image');
                            console.log('imageDiv:', imageDiv);
                            if (imageDiv) {
                                const style = imageDiv.getAttribute('style');
                                console.log('style attribute:', style);
                                if (style) {
                                    const urlMatch = style.match(/url\(['"]?(https?:\/\/[^'")\s]+)['"]?\)/);
                                    console.log('urlMatch:', urlMatch);
                                    if (urlMatch) {
                                        const imgSrc = urlMatch[1];
                                        console.log('Extracted background image URL:', imgSrc);
                                        
                                        // contactç³»ã®ç”»åƒãŒè¦‹ã¤ã‹ã£ãŸã‚‰å‡¦ç†ã‚’åœæ­¢
                                        if (imgSrc.includes('contact-mail') || imgSrc.includes('contact-call')) {
                                            console.log('Found contact image, stopping further processing:', imgSrc);
                                            stopProcessing = true;
                                            return;
                                        }
                                        
                                        articleImages.push({
                                            src: imgSrc,
                                            alt: imageDiv.getAttribute('alt') || ''
                                        });
                                        console.log('Added to articleImages, total:', articleImages.length);
                                        markdown += 'ã€IMGã€‘\n';
                                        return; // å‡¦ç†å®Œäº†ã—ãŸã‚‰å†å¸°ã¯ã‚¹ã‚­ãƒƒãƒ—
                                    }
                                }
                            }
                        }
                        
                        // å†å¸°çš„ã«å­è¦ç´ ã‚’å‡¦ç†
                        processNode(el);
                    }
                });
            }

            function processImage(img) {
                console.log('processImage called for img:', img);
                if (stopProcessing) {
                    console.log('  -> stopProcessing is true, skipping');
                    return;
                }
                
                let imgSrc = img.src || img.dataset.src || img.getAttribute('data-lazy-src');
                console.log('  -> imgSrc:', imgSrc);
                if (!imgSrc) {
                    console.log('  -> No src found, skipping');
                    return;
                }
                
                // contactç³»ã®ç”»åƒãŒè¦‹ã¤ã‹ã£ãŸã‚‰å‡¦ç†ã‚’åœæ­¢
                if (imgSrc.includes('contact-mail') || imgSrc.includes('contact-call')) {
                    console.log('  -> Found contact image, stopping further processing:', imgSrc);
                    stopProcessing = true;
                    return;
                }
                
                // ç›¸å¯¾URLã‚’çµ¶å¯¾URLã«å¤‰æ›
                if (!imgSrc.startsWith('http')) {
                    try {
                        const base = new URL(baseUrl);
                        imgSrc = new URL(imgSrc, base.origin).href;
                    } catch (e) {
                        console.warn('Failed to convert image URL:', imgSrc);
                    }
                }
                
                // å°ã•ã„ã‚¢ã‚¤ã‚³ãƒ³ã‚„ãƒ­ã‚´ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆwidth/heightãŒå°ã•ã„ã‚‚ã®ï¼‰
                const width = parseInt(img.width) || 0;
                const height = parseInt(img.height) || 0;
                console.log('  -> Image size:', width, 'x', height);
                if ((width > 0 && width < 50) || (height > 0 && height < 50)) {
                    console.log('  -> Image too small, skipping');
                    return;
                }
                
                console.log('  -> Adding image to articleImages');
                articleImages.push({
                    src: imgSrc,
                    alt: img.alt || 'ç”»åƒ'
                });
                
                markdown += 'â˜…ç”»åƒ\n';
            }

            // è¨˜äº‹æœ¬æ–‡ã‚’å‡¦ç†é–‹å§‹
            processNode(articleContent);
            
            // ä½™åˆ†ãªæ”¹è¡Œã‚’å‰Šé™¤ï¼ˆ3è¡Œä»¥ä¸Šã®é€£ç¶šæ”¹è¡Œã‚’2è¡Œã«ã™ã‚‹ï¼‰
            markdown = markdown.replace(/\n{3,}/g, '\n\n').trim();
            
            console.log('å‡¦ç†å¾Œã®markdown preview:', markdown.substring(0, 200));

            markdownEditor.value = markdown.trim();
            console.log('ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³è¨­å®šå®Œäº†, length:', markdown.length);
            console.log('ç”»åƒæ•°:', articleImages.length);
            
            updateHTML();
            displayImages();
            
            console.log('parseArticle å®Œäº†');
        }

        function displayImages() {
            console.log('displayImages called, articleImages.length:', articleImages.length);
            
            if (articleImages.length === 0) {
                imagesGrid.innerHTML = '<div class="empty-state">ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
                return;
            }

            imagesGrid.innerHTML = '';
            articleImages.forEach((img, index) => {
                console.log(`Image ${index}: src="${img.src}", alt="${img.alt}"`);
                const item = document.createElement('div');
                item.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 8px;';
                
                // ç”»åƒç•ªå·
                const label = document.createElement('div');
                label.textContent = `ç”»åƒ${index + 1}:`;
                label.style.cssText = 'font-weight: bold; color: #2c3e50; min-width: 60px;';
                item.appendChild(label);
                
                // æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ããƒœã‚¿ãƒ³ï¼ˆã‚°ãƒªãƒ¼ãƒ³ï¼‰
                const openBtn = document.createElement('button');
                openBtn.textContent = 'æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã';
                openBtn.style.cssText = 'flex: 1; padding: 8px 12px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px;';
                openBtn.addEventListener('click', function() {
                    window.open(img.src, '_blank');
                });
                item.appendChild(openBtn);
                
                imagesGrid.appendChild(item);
            });
        }

        function handleDragStart(event, index) {
            event.dataTransfer.setData('text/uri-list', articleImages[index].src);
            event.dataTransfer.setData('text/plain', articleImages[index].src);
        }

        function copyImageUrl(index, button) {
            const url = articleImages[index].src;
            navigator.clipboard.writeText(url).then(() => {
                const originalText = button.textContent;
                button.textContent = 'ã‚³ãƒ”ãƒ¼å®Œäº†ï¼';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            });
        }

        function updateHTML() {
            const markdown = markdownEditor.value;
            const result = convertToHTML(markdown);
            htmlOutput.textContent = result.html.trim();
            if (result.title) {
                titleDisplay.value = result.title;
            }
        }

        function convertToHTML(text) {
            if (!text.trim()) return { html: '', title: '' };

            let title = '';

            // YouTubeåŸ‹ã‚è¾¼ã¿
            text = text.replace(/https?:\/\/(?:www\.)?youtube\.com\/watch\?v=([a-zA-Z0-9_-]+)(?:[^\s]*)?/g, (match, videoId) => {
                return `<div class="yt">\n<iframe title="YouTube video player" src="https://www.youtube.com/embed/${videoId}" width="560" height="315" frameborder="0" allowfullscreen="allowfullscreen"></iframe>\n</div>`;
            });
            
            text = text.replace(/https?:\/\/(?:www\.)?youtu\.be\/([a-zA-Z0-9_-]+)(?:[^\s]*)?/g, (match, videoId) => {
                return `<div class="yt">\n<iframe title="YouTube video player" src="https://www.youtube.com/embed/${videoId}" width="560" height="315" frameborder="0" allowfullscreen="allowfullscreen"></iframe>\n</div>`;
            });

            let lines = text.split('\n');
            let html = '';
            let inList = false;
            let listType = '';
            let paragraphBuffer = [];

            function flushParagraph() {
                if (paragraphBuffer.length > 0) {
                    let content = paragraphBuffer.join('<br>');
                    html += '<p>' + processInlineFormatting(content) + '</p>\n';
                    paragraphBuffer = [];
                }
            }

            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];

                if (line.trim() === '') {
                    flushParagraph();
                    if (inList) {
                        html += listType === 'ul' ? '</ul>\n' : '</ol>\n';
                        inList = false;
                    }
                    html += '\n';
                    continue;
                }

                if (line.trim() === '---') {
                    flushParagraph();
                    if (inList) {
                        html += listType === 'ul' ? '</ul>\n' : '</ol>\n';
                        inList = false;
                    }
                    html += '<hr>\n';
                    continue;
                }

                if (line.startsWith('# ')) {
                    flushParagraph();
                    if (inList) {
                        html += listType === 'ul' ? '</ul>' : '</ol>';
                        inList = false;
                    }
                    const h1Text = line.substring(2);
                    title = h1Text;
                    continue;
                }
                if (line.startsWith('###### ')) {
                    flushParagraph();
                    if (inList) {
                        html += listType === 'ul' ? '</ul>' : '</ol>';
                        inList = false;
                    }
                    html += '<h6>' + line.substring(7) + '</h6>\n';
                    continue;
                }
                if (line.startsWith('##### ')) {
                    flushParagraph();
                    if (inList) {
                        html += listType === 'ul' ? '</ul>' : '</ol>';
                        inList = false;
                    }
                    html += '<h5>' + line.substring(6) + '</h5>\n';
                    continue;
                }
                if (line.startsWith('#### ')) {
                    flushParagraph();
                    if (inList) {
                        html += listType === 'ul' ? '</ul>' : '</ol>';
                        inList = false;
                    }
                    html += '<h4>' + line.substring(5) + '</h4>\n';
                    continue;
                }
                if (line.startsWith('### ')) {
                    flushParagraph();
                    if (inList) {
                        html += listType === 'ul' ? '</ul>' : '</ol>';
                        inList = false;
                    }
                    html += '<h3>' + line.substring(4) + '</h3>\n';
                    continue;
                }
                if (line.startsWith('## ')) {
                    flushParagraph();
                    if (inList) {
                        html += listType === 'ul' ? '</ul>' : '</ol>';
                        inList = false;
                    }
                    html += '<h2>' + line.substring(3) + '</h2>\n';
                    continue;
                }

                if (line.match(/^[-*]\s/)) {
                    flushParagraph();
                    if (!inList || listType !== 'ul') {
                        if (inList && listType === 'ol') html += '</ol>\n';
                        html += '<ul>\n';
                        inList = true;
                        listType = 'ul';
                    }
                    html += '  <li>' + processInlineFormatting(line.substring(2)) + '</li>\n';
                    continue;
                }

                if (line.match(/^\d+\.\s/)) {
                    flushParagraph();
                    if (!inList || listType !== 'ol') {
                        if (inList && listType === 'ul') html += '</ul>\n';
                        html += '<ol>\n';
                        inList = true;
                        listType = 'ol';
                    }
                    html += '  <li>' + processInlineFormatting(line.replace(/^\d+\.\s/, '')) + '</li>\n';
                    continue;
                }

                if (line.startsWith('â˜…ç”»åƒ')) {
                    flushParagraph();
                    if (inList) {
                        html += listType === 'ul' ? '</ul>\n' : '</ol>\n';
                        inList = false;
                    }
                    html += 'â˜…ç”»åƒ\n';
                    continue;
                }

                if (line.includes('<iframe')) {
                    flushParagraph();
                    if (inList) {
                        html += listType === 'ul' ? '</ul>\n' : '</ol>\n';
                        inList = false;
                    }
                    // iframeãŒè¤‡æ•°è¡Œã«ã¾ãŸãŒã‚‹å ´åˆã‚‚å¯¾å¿œ
                    let iframeCode = line;
                    while (!iframeCode.includes('</iframe>') && i + 1 < lines.length) {
                        i++;
                        iframeCode += lines[i];
                    }
                    html += iframeCode + '\n';
                    continue;
                }

                const urlOnlyMatch = line.trim().match(/^(https?:\/\/[^\s]+)$/);
                if (urlOnlyMatch) {
                    const url = urlOnlyMatch[1];
                    
                    // YouTube URLã¯ãã®ã¾ã¾å‡¦ç†
                    if (url.includes('youtube.com') || url.includes('youtu.be')) {
                        flushParagraph();
                        if (inList) {
                            html += listType === 'ul' ? '</ul>\n' : '</ol>\n';
                            inList = false;
                        }
                        html += '<a href="' + url + '" target="_blank">' + url + '</a>\n';
                        continue;
                    }
                    
                    // ç›´å‰ã«æ®µè½ãƒãƒƒãƒ•ã‚¡ãŒã‚ã‚‹å ´åˆã€ãã‚Œã‚’ãƒªãƒ³ã‚¯ãƒ†ã‚­ã‚¹ãƒˆã«ã™ã‚‹
                    if (paragraphBuffer.length > 0) {
                        const linkText = paragraphBuffer.join('<br>');
                        paragraphBuffer = [];
                        if (inList) {
                            html += listType === 'ul' ? '</ul>\n' : '</ol>\n';
                            inList = false;
                        }
                        html += '<a href="' + url + '" target="_blank">' + processInlineFormatting(linkText) + '</a>\n';
                        continue;
                    }
                    
                    // ç›´å‰ã«æ®µè½ãŒãªã„å ´åˆã¯ã€URLã‚’ãã®ã¾ã¾è¡¨ç¤º
                    flushParagraph();
                    if (inList) {
                        html += listType === 'ul' ? '</ul>\n' : '</ol>\n';
                        inList = false;
                    }
                    html += '<a href="' + url + '" target="_blank">' + url + '</a>\n';
                    continue;
                }

                // ALTï¼‰ã§å§‹ã¾ã‚‹è¡Œã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆPã‚¿ã‚°ã§å›²ã¾ãªã„ï¼‰
                if (line.trim().startsWith('ALTï¼‰')) {
                    flushParagraph();
                    if (inList) {
                        html += listType === 'ul' ? '</ul>\n' : '</ol>\n';
                        inList = false;
                    }
                    // ALTï¼‰ã‚’ãã®ã¾ã¾å‡ºåŠ›ï¼ˆPã‚¿ã‚°ãªã—ï¼‰
                    html += processInlineFormatting(line.trim()) + '\n';
                    continue;
                }

                // ï¼ˆCã€ï¼ˆä¸­å¤®ã€ï¼ˆå³ã€ï¼ˆå·¦ã€ï¼ˆALT ã§çµ‚ã‚ã‚‹è¡Œã‚’ãƒã‚§ãƒƒã‚¯
                if (line.trim().endsWith('ï¼ˆC') || line.trim().endsWith('ï¼ˆä¸­å¤®') || 
                    line.trim().endsWith('ï¼ˆå³') || line.trim().endsWith('ï¼ˆå·¦') || 
                    line.trim().endsWith('ï¼ˆALT')) {
                    flushParagraph();
                    if (inList) {
                        html += listType === 'ul' ? '</ul>\n' : '</ol>\n';
                        inList = false;
                    }
                    
                    // ãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤ã—ã¦Pã‚¿ã‚°ã§å›²ã‚€
                    let content = line.trim()
                        .replace(/ï¼ˆC$/, '')
                        .replace(/ï¼ˆä¸­å¤®$/, '')
                        .replace(/ï¼ˆå³$/, '')
                        .replace(/ï¼ˆå·¦$/, '')
                        .replace(/ï¼ˆALT$/, '');
                    
                    // ç©ºç™½ã®ã¿ã®å ´åˆã¯â˜…ã‚’å…¥ã‚Œã‚‹
                    if (content.trim() === '') {
                        content = 'â˜…';
                    }
                    
                    // ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ±ºå®š
                    let style = '';
                    if (line.trim().endsWith('ï¼ˆC')) {
                        style = 'margin-top: 15px;';
                    } else if (line.trim().endsWith('ï¼ˆä¸­å¤®')) {
                        style = 'text-align: center;';
                    } else if (line.trim().endsWith('ï¼ˆå³')) {
                        style = 'text-align: right;';
                    } else if (line.trim().endsWith('ï¼ˆå·¦')) {
                        style = ''; // å·¦æƒãˆã¯é€šå¸¸ã®P
                    }
                    
                    if (style) {
                        html += '<p style="' + style + '">' + processInlineFormatting(content) + '</p>\n';
                    } else {
                        html += '<p>' + processInlineFormatting(content) + '</p>\n';
                    }
                    continue;
                }

                if (inList) {
                    html += listType === 'ul' ? '</ul>\n' : '</ol>\n';
                    inList = false;
                }
                paragraphBuffer.push(line);
            }

            flushParagraph();

            if (inList) {
                html += listType === 'ul' ? '</ul>\n' : '</ol>\n';
            }

            return { html: html, title: title };
        }

        function processInlineFormatting(text) {
            text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/(https?:\/\/(?!(?:www\.)?(?:youtube\.com|youtu\.be))[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
            return text;
        }

        function copyHTML() {
            const html = htmlOutput.textContent;
            if (!html.trim()) {
                alert('HTMLã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const textarea = document.createElement('textarea');
            textarea.value = html;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                const button = event.target;
                button.textContent = 'âœ“ ã‚³ãƒ”ãƒ¼å®Œäº†ï¼';
                button.style.background = '#95a5a6';
            } catch (err) {
                console.error('ã‚³ãƒ”ãƒ¼å¤±æ•—:', err);
                alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
            } finally {
                document.body.removeChild(textarea);
            }
        }

        function copyTitle() {
            const title = titleDisplay.value;
            if (!title.trim()) {
                alert('ã‚¿ã‚¤ãƒˆãƒ«ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const textarea = document.createElement('textarea');
            textarea.value = title;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                const button = event.target;
                button.textContent = 'âœ“ ã‚³ãƒ”ãƒ¼å®Œäº†ï¼';
                button.style.background = '#95a5a6';
            } catch (err) {
                console.error('ã‚³ãƒ”ãƒ¼å¤±æ•—:', err);
                alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
            } finally {
                document.body.removeChild(textarea);
            }
        }

        function copyClient() {
            const client = clientDisplay.value;
            if (!client.trim()) {
                alert('ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const textarea = document.createElement('textarea');
            textarea.value = client;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                const button = event.target;
                button.textContent = 'âœ“ ã‚³ãƒ”ãƒ¼å®Œäº†ï¼';
                button.style.background = '#95a5a6';
            } catch (err) {
                console.error('ã‚³ãƒ”ãƒ¼å¤±æ•—:', err);
                alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
            } finally {
                document.body.removeChild(textarea);
            }
        }

        function copySlug() {
            const slug = slugDisplay.value;
            if (!slug.trim()) {
                alert('ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const textarea = document.createElement('textarea');
            textarea.value = slug;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                const button = event.target;
                button.textContent = 'âœ“ ã‚³ãƒ”ãƒ¼å®Œäº†ï¼';
                button.style.background = '#95a5a6';
            } catch (err) {
                console.error('ã‚³ãƒ”ãƒ¼å¤±æ•—:', err);
                alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
            } finally {
                document.body.removeChild(textarea);
            }
        }

        function applyFormat(format) {
            const start = markdownEditor.selectionStart;
            const end = markdownEditor.selectionEnd;
            
            if (format === 'image') {
                const beforeText = markdownEditor.value.substring(0, start);
                const afterText = markdownEditor.value.substring(end);
                markdownEditor.value = beforeText + 'â˜…ç”»åƒ\n' + afterText;
                const newPosition = start + 4;
                markdownEditor.setSelectionRange(newPosition, newPosition);
                markdownEditor.focus();
                updateHTML(); // æ‰‹å‹•æ›´æ–°
                return;
            }
            
            let selectedText = markdownEditor.value.substring(start, end);
            let realStart = start;
            let realEnd = end;
            
            if (start === end) {
                const text = markdownEditor.value;
                let lineStart = start;
                let lineEnd = end;
                
                while (lineStart > 0 && text[lineStart - 1] !== '\n') {
                    lineStart--;
                }
                
                while (lineEnd < text.length && text[lineEnd] !== '\n') {
                    lineEnd++;
                }
                
                selectedText = text.substring(lineStart, lineEnd);
                realStart = lineStart;
                realEnd = lineEnd;
            }
            
            if (!selectedText.trim() && format !== 'paragraph' && format !== 'alt') {
                alert('ãƒ†ã‚­ã‚¹ãƒˆã‚’é¸æŠã™ã‚‹ã‹ã€ã‚«ãƒ¼ã‚½ãƒ«ã‚’è¡Œã«é…ç½®ã—ã¦ãã ã•ã„');
                return;
            }

            let newText = '';
            const beforeText = markdownEditor.value.substring(0, realStart);
            const afterText = markdownEditor.value.substring(realEnd);

            switch(format) {
                case 'h1':
                    newText = '# ' + selectedText.replace(/^#{1,6}\s*/, '');
                    break;
                case 'h2':
                    newText = '## ' + selectedText.replace(/^#{1,6}\s*/, '');
                    break;
                case 'h3':
                    newText = '### ' + selectedText.replace(/^#{1,6}\s*/, '');
                    break;
                case 'h4':
                    newText = '#### ' + selectedText.replace(/^#{1,6}\s*/, '');
                    break;
                case 'h5':
                    newText = '##### ' + selectedText.replace(/^#{1,6}\s*/, '');
                    break;
                case 'h6':
                    newText = '###### ' + selectedText.replace(/^#{1,6}\s*/, '');
                    break;
                case 'bold':
                    newText = '**' + selectedText + '**';
                    break;
                case 'ul':
                    // æ—¢å­˜ã®ãƒªã‚¹ãƒˆãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰ç®‡æ¡æ›¸ãã«
                    newText = selectedText.split('\n').map(line => {
                        const trimmed = line.trim();
                        if (!trimmed) return line;
                        // æ—¢å­˜ã®ç•ªå·ä»˜ããƒªã‚¹ãƒˆã‚„ç®‡æ¡æ›¸ãã‚’å‰Šé™¤
                        const cleaned = trimmed.replace(/^[-*]\s+/, '').replace(/^\d+\.\s+/, '');
                        return '- ' + cleaned;
                    }).join('\n');
                    break;
                case 'ol':
                    // æ—¢å­˜ã®ãƒªã‚¹ãƒˆãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰ç•ªå·ä»˜ããƒªã‚¹ãƒˆã«
                    newText = selectedText.split('\n').map((line, i) => {
                        const trimmed = line.trim();
                        if (!trimmed) return line;
                        // æ—¢å­˜ã®ç•ªå·ä»˜ããƒªã‚¹ãƒˆã‚„ç®‡æ¡æ›¸ãã‚’å‰Šé™¤
                        const cleaned = trimmed.replace(/^[-*]\s+/, '').replace(/^\d+\.\s+/, '');
                        return `${i + 1}. ${cleaned}`;
                    }).join('\n');
                    break;
                case 'caption':
                    newText = selectedText + 'ï¼ˆC';
                    break;
                case 'alt':
                    // ãƒ†ã‚­ã‚¹ãƒˆé¸æŠæ™‚: ALTï¼‰ãƒ†ã‚­ã‚¹ãƒˆ
                    // ä½•ã‚‚ãªã„æ™‚: ALTï¼‰â˜…
                    if (selectedText.trim()) {
                        newText = 'ALTï¼‰' + selectedText;
                    } else {
                        newText = 'ALTï¼‰â˜…';
                    }
                    break;
                case 'paragraph':
                    // é¸æŠã•ã‚ŒãŸè¡Œã‚’ç©ºè¡Œã§å›²ã‚€ï¼ˆæ®µè½ã¨ã—ã¦æ‰±ã†ï¼‰
                    newText = selectedText;
                    // å‰ã«ç©ºè¡Œã‚’è¿½åŠ ï¼ˆæ—¢ã«ç©ºè¡ŒãŒãªã„å ´åˆï¼‰
                    const addBefore = beforeText.endsWith('\n\n') || beforeText === '' ? '' : '\n';
                    // å¾Œã‚ã«ç©ºè¡Œã‚’è¿½åŠ ï¼ˆæ—¢ã«ç©ºè¡ŒãŒãªã„å ´åˆï¼‰
                    const addAfter = afterText.startsWith('\n\n') || afterText === '' ? '' : '\n';
                    markdownEditor.value = beforeText + addBefore + newText + addAfter + afterText;
                    markdownEditor.focus();
                    updateHTML(); // æ‰‹å‹•æ›´æ–°
                    return;
            }

            markdownEditor.value = beforeText + newText + afterText;
            const newPosition = realStart + newText.length;
            markdownEditor.setSelectionRange(newPosition, newPosition);
            markdownEditor.focus();
            updateHTML(); // æ‰‹å‹•æ›´æ–°
        }

        function clearFormat() {
            const start = markdownEditor.selectionStart;
            const end = markdownEditor.selectionEnd;
            
            let selectedText = markdownEditor.value.substring(start, end);
            let realStart = start;
            let realEnd = end;
            
            // ã‚«ãƒ¼ã‚½ãƒ«ã®ã¿ã®å ´åˆã¯è¡Œå…¨ä½“ã‚’å¯¾è±¡ã«ã™ã‚‹
            if (start === end) {
                const text = markdownEditor.value;
                let lineStart = start;
                let lineEnd = end;
                
                while (lineStart > 0 && text[lineStart - 1] !== '\n') {
                    lineStart--;
                }
                
                while (lineEnd < text.length && text[lineEnd] !== '\n') {
                    lineEnd++;
                }
                
                selectedText = text.substring(lineStart, lineEnd);
                realStart = lineStart;
                realEnd = lineEnd;
            }
            
            if (!selectedText.trim()) {
                return;
            }
            
            const beforeText = markdownEditor.value.substring(0, realStart);
            const afterText = markdownEditor.value.substring(realEnd);
            
            // å„ç¨®ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³è¨˜æ³•ã‚’å‰Šé™¤
            let cleanText = selectedText
                .replace(/^#{1,6}\s+/gm, '')           // è¦‹å‡ºã— (#, ##, ###)
                .replace(/^\s*[-*]\s+/gm, '')          // ç®‡æ¡æ›¸ã (-, *)
                .replace(/^\s*\d+\.\s+/gm, '')         // ç•ªå·ä»˜ããƒªã‚¹ãƒˆ (1., 2., ...)
                .replace(/\*\*(.+?)\*\*/g, '$1')       // å¤ªå­— (**text**)
                .replace(/<p style="[^"]*">/gi, '')    // Pã‚¿ã‚°ï¼ˆstyleä»˜ãï¼‰
                .replace(/<p>/gi, '')                  // Pã‚¿ã‚°
                .replace(/<\/p>/gi, '')                // Pã‚¿ã‚°é–‰ã˜
                .replace(/ï¼ˆC$/gm, '')                 // ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³
                .replace(/ï¼ˆä¸­å¤®$/gm, '')              // ä¸­å¤®æƒãˆ
                .replace(/ï¼ˆå³$/gm, '')                // å³æƒãˆ
                .replace(/ï¼ˆå·¦$/gm, '')                // å·¦æƒãˆ
                .replace(/ï¼ˆALT$/gm, '');              // ALT
            
            markdownEditor.value = beforeText + cleanText + afterText;
            markdownEditor.setSelectionRange(realStart, realStart + cleanText.length);
            markdownEditor.focus();
            updateHTML(); // æ‰‹å‹•æ›´æ–°
        }

        function insertHR() {
            const start = markdownEditor.selectionStart;
            const end = markdownEditor.selectionEnd;
            const beforeText = markdownEditor.value.substring(0, start);
            const afterText = markdownEditor.value.substring(end);
            
            markdownEditor.value = beforeText + '---' + afterText;
            const newPosition = start + 3;
            markdownEditor.setSelectionRange(newPosition, newPosition);
            markdownEditor.focus();
            updateHTML(); // æ‰‹å‹•æ›´æ–°
        }

        function deleteLine() {
            const start = markdownEditor.selectionStart;
            const end = markdownEditor.selectionEnd;
            
            // ãƒ†ã‚­ã‚¹ãƒˆãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯é¸æŠéƒ¨åˆ†ã®ã¿å‰Šé™¤
            if (start !== end) {
                const beforeText = markdownEditor.value.substring(0, start);
                const afterText = markdownEditor.value.substring(end);
                markdownEditor.value = beforeText + afterText;
                markdownEditor.setSelectionRange(start, start);
                markdownEditor.focus();
                updateHTML(); // æ‰‹å‹•æ›´æ–°
                return;
            }
            
            // é¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚«ãƒ¼ã‚½ãƒ«ãŒã‚ã‚‹è¡Œå…¨ä½“ã‚’å‰Šé™¤
            const text = markdownEditor.value;
            let lineStart = start;
            let lineEnd = end;
            
            // è¡Œã®é–‹å§‹ä½ç½®ã‚’æ¢ã™
            while (lineStart > 0 && text[lineStart - 1] !== '\n') {
                lineStart--;
            }
            
            // è¡Œã®çµ‚äº†ä½ç½®ã‚’æ¢ã™ï¼ˆæ”¹è¡Œæ–‡å­—ã‚’å«ã‚€ï¼‰
            while (lineEnd < text.length && text[lineEnd] !== '\n') {
                lineEnd++;
            }
            if (lineEnd < text.length) lineEnd++; // æ”¹è¡Œæ–‡å­—ã‚‚å‰Šé™¤
            
            const beforeText = text.substring(0, lineStart);
            const afterText = text.substring(lineEnd);
            
            markdownEditor.value = beforeText + afterText;
            markdownEditor.setSelectionRange(lineStart, lineStart);
            markdownEditor.focus();
            updateHTML(); // æ‰‹å‹•æ›´æ–°
        }

        function insertLineBreak() {
            const start = markdownEditor.selectionStart;
            const end = markdownEditor.selectionEnd;
            const beforeText = markdownEditor.value.substring(0, start);
            const afterText = markdownEditor.value.substring(end);
            
            markdownEditor.value = beforeText + '\n' + afterText;
            const newPosition = start + 1;
            markdownEditor.setSelectionRange(newPosition, newPosition);
            markdownEditor.focus();
            updateHTML(); // æ‰‹å‹•æ›´æ–°
        }

        function applyAlign(align) {
            const start = markdownEditor.selectionStart;
            const end = markdownEditor.selectionEnd;
            const text = markdownEditor.value;
            
            // é¸æŠç¯„å›²ãŒãªã„å ´åˆã¯ç¾åœ¨ã®è¡Œã‚’å¯¾è±¡ã«ã™ã‚‹
            let lineStart = start;
            let lineEnd = end;
            
            if (start === end) {
                // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã®è¡Œå…¨ä½“ã‚’å–å¾—
                while (lineStart > 0 && text[lineStart - 1] !== '\n') {
                    lineStart--;
                }
                while (lineEnd < text.length && text[lineEnd] !== '\n') {
                    lineEnd++;
                }
            }
            
            const beforeText = text.substring(0, lineStart);
            const selectedText = text.substring(lineStart, lineEnd);
            const afterText = text.substring(lineEnd);
            
            // æ—¢å­˜ã®é…ç½®ãƒãƒ¼ã‚«ãƒ¼ã‚„Pã‚¿ã‚°ã‚’å‰Šé™¤
            let cleanedText = selectedText
                .replace(/<p style="[^"]*">/gi, '')
                .replace(/<p>/gi, '')
                .replace(/<\/p>/gi, '')
                .replace(/ï¼ˆä¸­å¤®$/gi, '')
                .replace(/ï¼ˆå³$/gi, '')
                .replace(/ï¼ˆå·¦$/gi, '')
                .replace(/ï¼ˆC$/gi, '')
                .replace(/ï¼ˆALT$/gi, '')
                .trim();
            
            // æ–°ã—ã„é…ç½®ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
            let newText;
            const alignMarker = align === 'center' ? 'ï¼ˆä¸­å¤®' : align === 'right' ? 'ï¼ˆå³' : 'ï¼ˆå·¦';
            newText = cleanedText + alignMarker;
            
            markdownEditor.value = beforeText + newText + afterText;
            markdownEditor.setSelectionRange(lineStart, lineStart + newText.length);
            markdownEditor.focus();
            updateHTML();
        }

        function resetAll() {
            // ã™ã¹ã¦ã‚¯ãƒªã‚¢
            markdownEditor.value = '';
            htmlSource.value = '';
            urlInput.value = '';
            titleDisplay.value = '';
            clientDisplay.value = '';
            slugDisplay.value = '';
            htmlOutput.innerHTML = '<div class="empty-state">URLã‚’å…¥åŠ›ã—ã¦ã€Œè¨˜äº‹ã‚’èª­ã¿è¾¼ã‚€ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</div>';
            imagesGrid.innerHTML = '<div class="empty-state">ç”»åƒã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>';
            articleImages = [];
            
            // ã™ã¹ã¦ã®ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã™
            const allButtons = document.querySelectorAll('button');
            allButtons.forEach(button => {
                if (button.textContent.includes('âœ“ ã‚³ãƒ”ãƒ¼å®Œäº†')) {
                    // ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ã®ç¨®é¡ã«å¿œã˜ã¦å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆã«æˆ»ã™
                    if (button.onclick && button.onclick.toString().includes('copyTitle')) {
                        button.textContent = 'ã‚³ãƒ”ãƒ¼';
                    } else if (button.onclick && button.onclick.toString().includes('copyClient')) {
                        button.textContent = 'ã‚³ãƒ”ãƒ¼';
                    } else if (button.onclick && button.onclick.toString().includes('copySlug')) {
                        button.textContent = 'ã‚³ãƒ”ãƒ¼';
                    } else if (button.id === 'copyHTMLBtn') {
                        button.textContent = 'HTMLã‚’ã‚³ãƒ”ãƒ¼';
                    }
                    button.style.background = button.id === 'copyHTMLBtn' ? '#27ae60' : '#3498db';
                }
            });
            
            markdownEditor.focus();
        }

        // ã™ã¹ã¦ã®ç”»åƒã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ãï¼ˆé †æ¬¡å®Ÿè¡Œï¼‰
        function openAllImages() {
            console.log('openAllImages called, articleImages.length:', articleImages.length);
            
            if (articleImages.length === 0) {
                alert('ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // 200msé–“éš”ã§é †æ¬¡é–‹ãï¼ˆãƒ–ãƒ­ãƒƒã‚¯å›é¿ï¼‰
            articleImages.forEach((img, index) => {
                setTimeout(() => {
                    console.log(`Opening image ${index + 1}:`, img.src);
                    window.open(img.src, '_blank');
                }, index * 200);
            });
        }
    </script>
</body>
</html>
